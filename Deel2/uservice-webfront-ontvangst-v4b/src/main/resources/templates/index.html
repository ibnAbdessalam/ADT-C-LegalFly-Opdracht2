<!doctype html>
<html lang="nl">
<head>
	<meta charset="utf-8">
	<title>LegalFly – Requests (CRUD)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>.card + .card{margin-top:.75rem}.truncate{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}</style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom"><div class="container"><span class="navbar-brand fw-semibold">LegalFly</span></div></nav>

<main class="container my-4">
	<div class="d-flex align-items-center mb-3">
		<h1 class="h4 mb-0">Requests</h1>
		<div class="ms-auto">
			<button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal" id="btnNew">Nieuw</button>
		</div>
	</div>

	<div id="alert" class="alert d-none" role="alert"></div>
	<div id="list" class="vstack"></div>
</main>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg"><div class="modal-content">
		<div class="modal-header">
			<h5 class="modal-title" id="modalTitle">Request</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		</div>
		<div class="modal-body">
			<form id="editForm" class="vstack gap-3">
				<input type="hidden" id="id">
				<div class="row g-3">
					<div class="col-md-8">
						<label class="form-label">Titel</label>
						<input id="title" class="form-control" required maxlength="255" placeholder="Contract review voor …">
					</div>
					<div class="col-md-4">
						<label class="form-label">Status</label>
						<select id="status" class="form-select">
							<option>PENDING</option><option>IN_PROGRESS</option><option>COMPLETED</option><option>CANCELLED</option>
						</select>
					</div>
				</div>
				<div class="row g-3">
					<div class="col-md-6">
						<label class="form-label">Klant e-mail</label>
						<input id="clientEmail" type="email" class="form-control" placeholder="client@example.com" required>
					</div>
				</div>
				<div>
					<label class="form-label">Beschrijving</label>
					<textarea id="description" class="form-control" rows="6" placeholder="(optioneel) beschrijving of contracttekst"></textarea>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
			<button id="btnSave" class="btn btn-primary">Opslaan</button>
		</div>
	</div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
	const API = '/api/requests'; // jouw controller pad

	const elList = document.getElementById('list');
	const elAlert = document.getElementById('alert');
	const modal = new bootstrap.Modal(document.getElementById('editModal'));
	const elId = document.getElementById('id');
	const elTitle = document.getElementById('title');
	const elStatus = document.getElementById('status');
	const elClientEmail = document.getElementById('clientEmail');
	const elDescription = document.getElementById('description');

	function esc(s){return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
	function alertMsg(kind,msg){elAlert.className='alert alert-'+kind;elAlert.textContent=msg;elAlert.classList.remove('d-none');setTimeout(()=>elAlert.classList.add('d-none'),2200)}
	async function http(m,u,b){const r=await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:b?JSON.stringify(b):undefined});if(!r.ok)throw new Error(m+' '+u+' -> '+r.status);return r.status===204?null:r.json()}

	async function load(){
		elList.replaceChildren();
		try{
			const data = await http('GET', API);
			if(!Array.isArray(data) || !data.length){elList.innerHTML='<div class="text-muted">Geen requests gevonden.</div>';return;}
			data.forEach(r=>elList.appendChild(row(r)));
		}catch(e){alertMsg('danger','Laden mislukt')}
	}

	function row(r){
		const el=document.createElement('div');el.className='card shadow-sm';
		el.innerHTML=`
      <div class="card-body d-flex align-items-start">
        <div class="flex-grow-1">
          <h5 class="card-title mb-1">${esc(r.title)}</h5>
          <span class="badge bg-secondary">${r.status}</span>
          <div class="small text-muted mt-1">${r.clientEmail?esc(r.clientEmail):''}</div>
          <p class="card-text mt-2 truncate">${r.description?esc(r.description):''}</p>
        </div>
        <div class="ms-3 d-flex flex-column gap-2">
          <button class="btn btn-sm btn-outline-secondary" data-action="view">Details</button>
          <button class="btn btn-sm btn-outline-primary" data-action="edit">Bewerken</button>
          <button class="btn btn-sm btn-outline-danger" data-action="delete">Delete</button>
        </div>
      </div>`;
		el.querySelector('[data-action="view"]').onclick=()=>view(r.id);
		el.querySelector('[data-action="edit"]').onclick=()=>openEdit(r);
		el.querySelector('[data-action="delete"]').onclick=()=>removeItem(r.id);
		return el;
	}

	function openCreate(){document.getElementById('modalTitle').textContent='Nieuw request';elId.value='';elTitle.value='';elStatus.value='PENDING';elClientEmail.value='';elDescription.value='';modal.show()}
	function openEdit(r){document.getElementById('modalTitle').textContent='Request bewerken';elId.value=r.id;elTitle.value=r.title||'';elStatus.value=r.status||'PENDING';elClientEmail.value=r.clientEmail||'';elDescription.value=r.description||'';modal.show()}

	async function save(){
		const payload={title:elTitle.value.trim(),status:elStatus.value,clientEmail:elClientEmail.value.trim(),description:elDescription.value};
		if(!payload.title){alertMsg('warning','Titel is verplicht');return;}
		if(!payload.clientEmail){alertMsg('warning','E-mail is verplicht');return;}
		try{
			if(elId.value) await http('PUT', `${API}/${elId.value}`, payload);
			else await http('POST', API, payload);
			modal.hide(); await load(); alertMsg('success','Opgeslagen');
		}catch(e){alertMsg('danger','Opslaan mislukt')}
	}

	async function removeItem(id){ if(!confirm('Zeker verwijderen?')) return;
		try{ await http('DELETE', `${API}/${id}`); await load(); alertMsg('success','Verwijderd'); }
		catch(e){ alertMsg('danger','Verwijderen mislukt'); }
	}

	async function view(id){
		try{
			const r = await http('GET', `${API}/${id}`);
			alert(
					`ID: ${r.id}\nTitel: ${r.title}\nStatus: ${r.status}\nE-mail: ${r.clientEmail}\n\n${r.description??''}`
			);
		}catch(e){ alertMsg('warning','Detail ophalen mislukt'); }
	}

	document.getElementById('btnNew').onclick=openCreate;
	document.getElementById('btnSave').onclick=save;
	load();
</script>
</body>
</html>
